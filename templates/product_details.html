{% extends "base.html" %}
{% block content %}
<div class="product-details">
    <div class="left">
        <img src="{{ product['image_url'] }}" alt="{{ product['name'] }}">
    </div>
    <div class="right">
        <h1>{{ product['name'] }}</h1>
        <p class="cat">{{ product['category_name'] }}</p>
        <p class="desc">{{ product['description'] }}</p>
        <h2 class="price">{{ "{:,.0f}".format(product['price']) }} Ø¬Ù†ÙŠÙ‡</h2>
        <p class="owner">Ø§Ù„Ø¨Ø§Ø¦Ø¹: {{ product['fullname'] }}</p>
        
        {% if current_user.is_authenticated and current_user.id != product.user_id %}
        <!-- Price Negotiation Section -->
        <div class="price-negotiation" id="negotiationSection">
            <h3>ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±</h3>
            <div class="price-slider-container">
                <label for="priceSlider">Ø§Ù‚ØªØ±Ø­ Ø³Ø¹Ø±Ùƒ:</label>
                <div class="slider-wrapper">
                    <input type="range" 
                           id="priceSlider" 
                           min="{{ (product['price'] * 0.3)|round|int }}" 
                           max="{{ product['price'] }}" 
                           value="{{ (product['price'] * 0.8)|round|int }}" 
                           class="price-slider">
                    <div class="price-display">
                        <span id="proposedPrice">{{ (product['price'] * 0.8)|round|int }}</span> Ø¬Ù†ÙŠÙ‡
                    </div>
                </div>
                <div class="price-range-labels">
                    <span>{{ (product['price'] * 0.3)|round|int }}</span>
                    <span>{{ product['price'] }}</span>
                </div>
            </div>
            
            <div class="negotiation-form">
                <textarea id="negotiationMessage" 
                          placeholder="Ø£Ø¶Ù Ø±Ø³Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" 
                          maxlength="500"></textarea>
                <button id="sendNegotiation" class="btn btn-primary">
                    <i class="fas fa-handshake"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±
                </button>
            </div>
            
            <div id="negotiationResult" class="negotiation-result"></div>
        </div>
        {% elif current_user.is_authenticated %}
        <div class="owner-message">
            <p><i class="fas fa-info-circle"></i> Ù‡Ø°Ø§ Ù…Ù†ØªØ¬Ùƒ Ø§Ù„Ø®Ø§Øµ</p>
            {% if current_user.role == 'admin' %}
            <div class="admin-controls">
                <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-warning">
                    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
                </a>
                <a href="{{ url_for('delete_product', product_id=product.id) }}" 
                   class="btn btn-danger"
                   onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬
                </a>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="login-prompt">
            <p>Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±</p>
            <a href="{{ url_for('login') }}" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        </div>
        {% endif %}
        
        <!-- Contact Seller Section -->
        <div class="contact-seller-section" style="margin-top: 20px;">
            <button type="button" class="btn btn-success contact-seller-btn" data-bs-toggle="modal" data-bs-target="#contactSellerModal">
                <i class="fas fa-envelope"></i> ğŸ“© Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹
            </button>
            
            {% if product.get('seller_phone') %}
            <a href="tel:{{ product.get('seller_phone') }}" class="btn btn-info" style="margin-left: 10px;">
                <i class="fas fa-phone"></i> ğŸ“ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø§Ø¦Ø¹
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Contact Seller Modal -->
<div class="modal fade" id="contactSellerModal" tabindex="-1" aria-labelledby="contactSellerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contactSellerModalLabel">
                    ğŸ“© Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹: {{ product['fullname'] }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="contactSellerForm">
                    <input type="hidden" id="productId" value="{{ product.id }}">
                    <input type="hidden" id="sellerId" value="{{ product.user_id }}">
                    
                    <div class="mb-3">
                        <label for="buyerName" class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                        <input type="text" class="form-control" id="buyerName" required 
                               {% if current_user.is_authenticated %}
                               value="{{ current_user.fullname }}" readonly style="background-color: #f8f9fa;"
                               {% else %}
                               placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ"
                               {% endif %}>
                    </div>
                    
                    <div class="mb-3">
                        <label for="buyerEmail" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" class="form-control" id="buyerEmail" required 
                               {% if current_user.is_authenticated %}
                               value="{{ current_user.email }}" readonly style="background-color: #f8f9fa;"
                               {% else %}
                               placeholder="example@email.com"
                               {% endif %}>
                    </div>
                    
                    <div class="mb-3">
                        <label for="messageText" class="form-label">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                        <textarea class="form-control" id="messageText" rows="4" required placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ù†Ø§..."></textarea>
                    </div>
                </form>
                <div id="contactResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" id="sendContactMessage">
                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const priceSlider = document.getElementById('priceSlider');
    const proposedPriceDisplay = document.getElementById('proposedPrice');
    const sendButton = document.getElementById('sendNegotiation');
    const messageTextarea = document.getElementById('negotiationMessage');
    const resultDiv = document.getElementById('negotiationResult');
    
    if (priceSlider) {
        // Update price display when slider moves
        priceSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            proposedPriceDisplay.textContent = value.toLocaleString();
            
            // Change color based on percentage of original price
            const originalPrice = {{ product['price'] }};
            const percentage = (value / originalPrice) * 100;
            
            if (percentage < 50) {
                this.style.background = '#ff4757';
            } else if (percentage < 75) {
                this.style.background = '#ffa502';
            } else {
                this.style.background = '#2ed573';
            }
        });
        
        // Send negotiation
        sendButton.addEventListener('click', function() {
            const proposedPrice = parseInt(priceSlider.value);
            const message = messageTextarea.value.trim();
            
            // Disable button during request
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            fetch('/api/negotiate_price', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: {{ product['id'] }},
                    offered_price: proposedPrice,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> ${data.message}
                        </div>
                    `;
                    sendButton.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
                    setTimeout(() => {
                        sendButton.innerHTML = '<i class="fas fa-handshake"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±';
                        sendButton.disabled = false;
                    }, 3000);
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <i class="fas fa-exclamation-circle"></i> ${data.message}
                        </div>
                    `;
                    sendButton.innerHTML = '<i class="fas fa-handshake"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±';
                    sendButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle"></i> Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
                    </div>
                `;
                sendButton.innerHTML = '<i class="fas fa-handshake"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±';
                sendButton.disabled = false;
            });
        });
    }
    
    // Contact Seller functionality
    const sendContactButton = document.getElementById('sendContactMessage');
    const contactResult = document.getElementById('contactResult');
    
    if (sendContactButton) {
        sendContactButton.addEventListener('click', function() {
            const productId = document.getElementById('productId').value;
            const sellerId = document.getElementById('sellerId').value;
            const buyerName = document.getElementById('buyerName').value.trim();
            const buyerEmail = document.getElementById('buyerEmail').value.trim();
            const messageText = document.getElementById('messageText').value.trim();
            
            // Validation
            if (!buyerName || !buyerEmail || !messageText) {
                contactResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
                    </div>
                `;
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(buyerEmail)) {
                contactResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­
                    </div>
                `;
                return;
            }
            
            // Disable button during request
            sendContactButton.disabled = true;
            sendContactButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            fetch('/api/contact_seller', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    seller_id: sellerId,
                    buyer_name: buyerName,
                    buyer_email: buyerEmail,
                    message_text: messageText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    contactResult.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø¨Ù†Ø¬Ø§Ø­!
                        </div>
                    `;
                    // Clear form
                    document.getElementById('contactSellerForm').reset();
                    // Auto-close modal after 3 seconds
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('contactSellerModal'));
                        if (modal) modal.hide();
                    }, 3000);
                } else {
                    contactResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> ${data.message}
                        </div>
                    `;
                }
                
                sendContactButton.innerHTML = '<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©';
                sendContactButton.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                contactResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                    </div>
                `;
                sendContactButton.innerHTML = '<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©';
                sendContactButton.disabled = false;
            });
        });
    }
});
</script>
{% endblock %}
